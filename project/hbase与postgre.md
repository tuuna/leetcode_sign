## 为什么研究

航迹数据是一系列的历史时空数据的集合，由于其时间和空间的特性，其查询也相对复杂。航迹数据的查询方式根据底层数据结构各不相同，典型的航迹数据查询是基本的点线面的空间查询：(1)航迹与区域的查询，例如查找某一时间段内所有经过某一行政区的航迹。(2)航迹之间的查询，例如两架飞机在某一时间段是否在同一航迹上飞行。（3）航迹相似性检查，采用Hausdoff距离作为度量来评判轨迹间的相似度，我们预先设定合适的阈值，将在指定区域内与给定航迹Hausdoff距离不超过阈值的航迹检索为相似航迹。



## 调研过程

轨迹数据的存储形式的发展与一般时空数据的存储相似，同样经历了从文件存储到关系型数据库存储，再到非关系型数据库的存储。

(1)文件存储：

文件存储是早期时空轨迹数据的主要存储形式。获取的轨迹的原始数据通常是文件形式，很多学者直接使用轨迹数据的原始文件作为轨迹数据的数据集，在此之上进行数据挖掘。Zhenhui Li等采用Brinkhoff的基于网络的移动数据设备获取的原始数据，利用C++对轨迹数据集进行数据挖掘。rik Lindahl等开发了GROMACS3．0系统用于轨迹分析，将轨迹文件输入系统，经过处理生成符合出图软件规则的格式，以便于生成图像进行可视化操作。

(2)关系型数据库存储

实体关系模型是最早且普及最广泛的数据库模型，目前也已经应用于时空数据存储的研究领域中。Tryfona提出一种实体关系模型用于存储时间与空间相关的数据存储中，同时设计了适用于时空数据的实体关系符号。

(3)非关系型数据库

关系数据库通常关注一致性和可用性，而非关系型数据库往往在分区容错性和可用性等方面提供优化。最近，非关系型数据库由于其强大的大数据处理的能力受到欢迎，因为他们能够提供的水平扩展能力和简单的数据访问机制。因此使用非关系型数据库来存储。

现有的常见轨迹索引方式可以被分为三类：

\1.   空间时间独立索引

从R树等传统空间索引上扩展出来，比如STR树和TB树(Trajectory BundleTrees)，把时间维与空间维独立开来，以此来构建一棵存储轨迹的三维R树(3D-Rtree)。时空查询就是在三维R树中查找落在三维查询长方体(three—dimensional query box)内的节点。这类索引的缺点在于随着越来越多的新生成的轨迹数据插入到三维R树上，不同轨迹的三维查询长方体之间相互重叠的部分也随之增多。

![img](file:////Users/laijie/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image002.jpg)

\2.   基于时间段划分的方法

将全部时间范围分成多个时间段，对每个时间段的轨迹数据分别建立独立的空间索引(比如R树)。多个时间段间共享不随时间改变的节点，一些有代表性的索引结构通常为R树的变体，例如RT树、HR树，和MV3R树。如图所示，在进行时空范围查询时，这种索引会先寻找落在时间查询范围内的时间段，然后再在对应时问段节点上进行空间查询。

![img](file:////Users/laijie/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image004.jpg)

\3.   基于空间划分的方法

先将轨迹点按照地理空间划分成格网，再对落入每个格网的轨迹数据通过混合B+树(HybridB+Tree)等方式建立时间索引。当检索轨迹数据满足某个时空查询时，CSE树首先找到从属空间范围的格网，再在这些格网中用混合B+树搜索所查询时间范围内的轨迹段。最后CSE树再将所有满足条件的轨迹段(包括它们的起、止时问)依据轨迹ID结合起来。显然，这种索引方式是先考虑空间维，然后再考虑时间维。

![img](file:////Users/laijie/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image006.jpg)

## Hbase分布式存储方案

Hadoop是目前流行的开源分布式文件系统方案，广泛应用于海量数据处理，HBase是基于 Hadoop的分布式、面向列的开源数据库。本方案采用基于 Hadoop的分布式文件系统（HDFS）作为空间数据的物理存储方式，并通过设计空间数据的存储模型、分布式空间索引方式，提出一种基于 HBase的分布式空间数据库架构设计方案。

HBase数据库集群包括主节点HMaster和若干个数据表服务器节点 HRegionServer。在 HBase中，一个表根据键值范围被拆分为数个数据表分片HRegion，每个数据表分片中包括内存存储MemStore和文件存储StoreFiles，文件存储中的每个文件对应 HDFS中的文件。当数据表服务器读取HBase中的表时，在内存存储中保存键值记录。对 HBase的数据访问优先通过访问内存存储获取数据，写入数据时除写入内存存储，还同时写入日志文件 Hlog，当日志文件记录一定量的写入内容后会同步到 HDFS中。HBase的数据组织结构如下所示。

![img](file:////Users/laijie/Library/Group%20Containers/UBF8T346G9.Office/TemporaryItems/msohtmlclip/clip_image002.jpg)

 在 HBase中，一个空间要素数据集由元数据表、空间索引表和数据记录表组成，分别用于保存数据集的字段结构、空间索引和所有空间要素的值。而在基于键值存储的分布式数据库中，可采用Geohash保存空间索引。

geohash详细步骤

本方案中将二维或多维空间坐标降维至一维既可以排序又可以比较的字符串的方法是Geohash，该方法有相对简单的数学模型，降维运算相对快，是一种良好的选择。以下是对于一个点进行Geohash的算法步骤：

步骤1 将纬度范围（-90，90）平分成两个区间（-90，0）、（0，90），如果目标纬度位于前一个区间，则编码为0，否则编码为1。

步骤2 若步骤1编码为0，将纬度范围（-90，0）平分成两个区间（-90，-45）、（-45，0），如果目标纬度位于前一个区间，则编码为0，否则编码为1。

步骤3 若步骤1编码为1，同步骤2，将纬度范围（0，90）平均分区。

步骤4 依据步骤2和步骤3对纬度进行划分，直到精度符合要求为止，得到纬度编码。

步骤5 经度编码同纬度算法，对（-180,180）依次细分，直到精度符合要求为止，得到经度编码。

步骤6 将经度和纬度的编码合并，奇数位是纬度，偶数位是精度。

步骤7 对步骤6合并的编码进行base32编码。



1）由于GeoHash是将区域划分为一个个规则矩形，并对每个矩形进行编码，这样在查询附近POI信息时会导致以下问题，比如红色的点是我们的位置，绿色的两个点分别是附近的两个餐馆，但是在查询的时候会发现距离较远餐馆的GeoHash编码与我们一样（因为在同一个GeoHash区域块上），而较近餐馆的GeoHash编码与我们不一致。这个问题往往产生在边界处。


解决的思路很简单，我们查询时，除了使用定位点的GeoHash编码进行匹配外，还使用周围8个区域的GeoHash编码，这样可以避免这个问题。

2）我们已经知道现有的GeoHash算法使用的是Peano空间填充曲线，这种曲线会产生突变，造成了编码虽然相似但距离可能相差很大的问题，因此在查询附近餐馆时候，首先筛选GeoHash编码相似的POI点，然后进行实际距离计算。
